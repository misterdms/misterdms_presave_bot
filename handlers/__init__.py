"""
–ú–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π Telegram Bot - Do Presave Reminder Bot v25+
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ü–õ–ê–ù 1: –ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–ê–ö–¢–ò–í–ù–´–ï)
–ü–õ–ê–ù 2: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Ä–º—ã (–ó–ê–ì–õ–£–®–ö–ò)
–ü–õ–ê–ù 3: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ò–ò –∏ —Ñ–æ—Ä–º (–ó–ê–ì–õ–£–®–ö–ò)
–ü–õ–ê–ù 4: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ backup (–ó–ê–ì–õ–£–®–ö–ò)
"""

from utils.logger import get_logger

logger = get_logger(__name__)

# ============================================
# –ü–õ–ê–ù 1: –ë–ê–ó–û–í–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò (–ê–ö–¢–ò–í–ù–´–ï)
# ============================================

# –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ - –≤—Å–µ–≥–¥–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è
from .menu import MenuHandler
from .commands import CommandHandler
from .callbacks import CallbackHandler
from .messages import MessageHandler
from .links import LinkHandler

# ============================================
# –ü–õ–ê–ù 2: –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ê–†–ú–´ (–ó–ê–ì–õ–£–®–ö–ò)
# ============================================

# TODO: –ò–º–ø–æ—Ä—Ç –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ –ü–õ–ê–ù–ï 2
# from .karma_handlers import KarmaHandler

# ============================================
# –ü–õ–ê–ù 3: –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ò–ò –ò –§–û–†–ú (–ó–ê–ì–õ–£–®–ö–ò)
# ============================================

# TODO: –ò–º–ø–æ—Ä—Ç –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ –ü–õ–ê–ù–ï 3
# from .ai_handlers import AIHandler
# from .form_handlers import FormHandler

# ============================================
# –ü–õ–ê–ù 4: –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò BACKUP (–ó–ê–ì–õ–£–®–ö–ò)
# ============================================

# TODO: –ò–º–ø–æ—Ä—Ç –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ –ü–õ–ê–ù–ï 4
# from .backup_commands import BackupCommandHandler

# ============================================
# –≠–ö–°–ü–û–†–¢ –ê–ö–¢–ò–í–ù–´–• –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í
# ============================================

__all__ = [
    # –ü–õ–ê–ù 1 (–ê–ö–¢–ò–í–ù–´–ï)
    'MenuHandler',
    'CommandHandler', 
    'CallbackHandler',
    'MessageHandler',
    'LinkHandler',
    
    # –ü–õ–ê–ù 2 (–ó–ê–ì–õ–£–®–ö–ò)
    # 'KarmaHandler',
    
    # –ü–õ–ê–ù 3 (–ó–ê–ì–õ–£–®–ö–ò)
    # 'AIHandler',
    # 'FormHandler',
    
    # –ü–õ–ê–ù 4 (–ó–ê–ì–õ–£–®–ö–ò)
    # 'BackupCommandHandler',
]

# ============================================
# –§–£–ù–ö–¶–ò–ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
# ============================================

def get_available_handlers():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
    return {
        'plan_1': [
            'MenuHandler',
            'CommandHandler', 
            'CallbackHandler',
            'MessageHandler',
            'LinkHandler'
        ],
        'plan_2': [
            # 'KarmaHandler'  # –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
        ],
        'plan_3': [
            # 'AIHandler',     # –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
            # 'FormHandler'    # –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
        ],
        'plan_4': [
            # 'BackupCommandHandler'  # –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
        ]
    }

def init_handlers(bot, db_manager, security_manager, config):
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    
    Args:
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞
        db_manager: –ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        security_manager: –ú–µ–Ω–µ–¥–∂–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞
        
    Returns:
        Dict —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
    """
    handlers = {}
    
    try:
        # –ü–õ–ê–ù 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        logger.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ü–õ–ê–ù 1...")
        
        handlers['menu'] = MenuHandler(bot, db_manager, security_manager)
        handlers['commands'] = CommandHandler(bot, db_manager, security_manager)
        handlers['callbacks'] = CallbackHandler(bot, db_manager, security_manager)
        handlers['messages'] = MessageHandler(bot, db_manager, security_manager)
        handlers['links'] = LinkHandler(bot, db_manager, security_manager)
        
        logger.info("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ü–õ–ê–ù 1 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
        
        # –ü–õ–ê–ù 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–∞—Ä–º—ã (–ó–ê–ì–õ–£–®–ö–ò)
        if getattr(config, 'ENABLE_PLAN_2_FEATURES', False):
            logger.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ü–õ–ê–ù 2...")
            # TODO: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é KarmaHandler
            logger.info("‚è∏Ô∏è –ü–õ–ê–ù 2 - –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
        
        # –ü–õ–ê–ù 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ò–ò –∏ —Ñ–æ—Ä–º (–ó–ê–ì–õ–£–®–ö–ò)
        if getattr(config, 'ENABLE_PLAN_3_FEATURES', False):
            logger.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ü–õ–ê–ù 3...")
            # TODO: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é AIHandler, FormHandler
            logger.info("‚è∏Ô∏è –ü–õ–ê–ù 3 - –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
        
        # –ü–õ–ê–ù 4: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ backup (–ó–ê–ì–õ–£–®–ö–ò)
        if getattr(config, 'ENABLE_PLAN_4_FEATURES', False):
            logger.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ü–õ–ê–ù 4...")
            # TODO: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é BackupCommandHandler
            logger.info("‚è∏Ô∏è –ü–õ–ê–ù 4 - –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
        
        logger.info(f"‚úÖ –í—Å–µ–≥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: {len(handlers)}")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: {e}")
        raise
    
    return handlers

def register_handlers(bot, handlers):
    """
    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ –±–æ—Ç–µ
    
    Args:
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞
        handlers: –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
    """
    try:
        logger.info("üîÑ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ –±–æ—Ç–µ...")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
        if 'commands' in handlers:
            handlers['commands'].register_commands()
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è callback'–æ–≤
        if 'callbacks' in handlers:
            bot.callback_query_handler(func=lambda call: True)(
                handlers['callbacks'].handle_callback
            )
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
        if 'messages' in handlers:
            bot.message_handler(func=lambda message: True)(
                handlers['messages'].handle_message
            )
        
        logger.info("‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–æ—Ç–µ")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: {e}")
        raise

# ============================================
# –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ú–û–î–£–õ–ï
# ============================================

def get_module_info():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–¥—É–ª–µ handlers"""
    return {
        'name': 'handlers',
        'version': 'v25+',
        'description': '–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Telegram Bot',
        'plans': {
            'plan_1': '–ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ - –ê–ö–¢–ò–í–ù–´',
            'plan_2': '–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Ä–º—ã - –í –†–ê–ó–†–ê–ë–û–¢–ö–ï',
            'plan_3': '–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ò–ò –∏ —Ñ–æ—Ä–º - –í –†–ê–ó–†–ê–ë–û–¢–ö–ï',
            'plan_4': '–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ backup - –í –†–ê–ó–†–ê–ë–û–¢–ö–ï'
        }
    }

logger.info("üì¶ –ú–æ–¥—É–ª—å handlers/__init__.py –∑–∞–≥—Ä—É–∂–µ–Ω")